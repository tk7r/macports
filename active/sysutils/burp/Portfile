# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4
# $Id: Portfile 126690 2014-10-13 20:34:27Z mf2k@macports.org $

PortSystem          1.0

name                burp
version             1.4.40
categories          sysutils
platforms           darwin
license             {AGPL-3 OpenSSLException}
maintainers         lausa.at:thomas.kotzian

description         network backup and restore program
long_description    Burp is a network backup and restore program. It uses librsync in \
                    order to save network traffic and to save on the amount of space \
                    that is used by each backup. It also uses VSS (Volume Shadow Copy \
                    Service) to make snapshots when backing up Windows computers.

homepage            http://burp.grke.org
master_sites        sourceforge
use_bzip2           yes

distname            burp-${version}
worksrcdir          burp-${version}

checksums           rmd160  3ba2a60605562bbff7bacc600ee511c3ce020995 \
                    sha256  4108eb45e14740de990d918a2adbb661d88f90de48d6e2e3a6b54fd12b16fa5e

depends_lib         port:ncurses \
                    port:openssl \
                    port:tcp_wrappers \
                    port:librsync \
                    port:zlib \
                    port:uthash \
                    port:gettext \
                    port:bzip2

configure.ccache    no
configure.args      --sbindir=${prefix}/sbin \
                    --mandir=${prefix}/share/man \
                    --docdir=${prefix}/share/doc/burp \
                    --datarootdir=${prefix}/share \
                    --sysconfdir=${prefix}/etc/${name} \
                    --with-libintl-prefix=${prefix} \
                    --with-openssl=${prefix} \
                    --with-libiconv-prefix=${prefix} \
                    --with-tcp-wrappers \
                    --without-x

configure.cppflags  -I${prefix}/include -I${prefix}/include/uthash

patch.args          -p1
patchfiles          config-fix.patch

post-patch {
    # reinplace prefix in configuration definitions added by config-fix.patch
    reinplace "s|@PREFIX@|${prefix}|g" ${worksrcpath}/README
    reinplace "s|@PREFIX@|${prefix}|g" ${worksrcpath}/configs/certs/CA/CA.cnf
    reinplace "s|@PREFIX@|${prefix}|g" ${worksrcpath}/configs/certs/CA/README
    reinplace "s|@PREFIX@|${prefix}|g" ${worksrcpath}/configs/certs/CA/burp_ca
    reinplace "s|@PREFIX@|${prefix}|g" ${worksrcpath}/configs/client/burp.conf
    reinplace "s|@PREFIX@|${prefix}|g" ${worksrcpath}/configs/server/burp.conf
    reinplace "s|@PREFIX@|${prefix}|g" ${worksrcpath}/configs/server/offsite-backup
    reinplace "s|@PREFIX@|${prefix}|g" ${worksrcpath}/manpages/bedup.8
    reinplace "s|@PREFIX@|${prefix}|g" ${worksrcpath}/manpages/burp.8
    reinplace "s|@PREFIX@|${prefix}|g" ${worksrcpath}/manpages/burp_ca.8
}

destroot.keepdirs   ${destroot}${prefix}/var/burp \
                    ${destroot}${prefix}/etc/burp/CA-client

post-destroot {
    file mkdir ${destroot}${prefix}/var/burp
    file mkdir ${destroot}${prefix}/etc/burp/CA-client
}

variant x11 description "Enable X11 support" {
    configure.args-delete --without-x
    configure.args-append --with-x
}

startupitem.create  yes
startupitem.executable "${prefix}/sbin/burp -c ${prefix}/etc/burp/burp-server.conf"

pre-deactivate {
    if {[file exists /Library/LaunchDaemons/org.macports.burp.plist]} {
         system "launchctl unload /Library/LaunchDaemons/org.macports.burp.plist"
    }
}

livecheck.type           regex
livecheck.url            ${homepage}
livecheck.regex          {burp ([0-9\.]+)}
